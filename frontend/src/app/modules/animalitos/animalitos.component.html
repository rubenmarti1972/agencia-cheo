<div class="animalitos-page">
  <div class="container">
    <!-- Header -->
    <div class="page-header">
      <h1>üêò Animalitos</h1>
      <p>Elige tu animalito de la suerte del 1 al 36 y multiplica tus ganancias</p>
    </div>

    <!-- Loading -->
    @if (loading() && !successTicket()) {
      <div class="loading-card card">
        <p class="text-center">Cargando...</p>
      </div>
    }

    <!-- Error -->
    @if (error()) {
      <div class="error-card card">
        <p>{{ error() }}</p>
        <button class="btn btn-primary btn-sm" (click)="loadGamesAndAnimalitos()">Reintentar</button>
      </div>
    }

    <!-- Success Ticket -->
    @if (successTicket()) {
      <div class="success-card card fade-in">
        <div class="success-icon">‚úÖ</div>
        <h2>¬°Apuesta Registrada!</h2>
        <div class="ticket-info">
          <p class="ticket-code">{{ successTicket()!.ticketCode }}</p>
          <p class="text-secondary">Guarda este c√≥digo para consultar tu ticket</p>
        </div>
        <div class="ticket-details">
          <div class="detail">
            <span>Juego:</span>
            <strong>{{ selectedGame()?.name }}</strong>
          </div>
          @if (successTicket()!.bet.animalito) {
            <div class="detail">
              <span>Animalito:</span>
              <strong>#{{ successTicket()!.bet.animalito!.number }} - {{ successTicket()!.bet.animalito!.name }}</strong>
            </div>
          }
          <div class="detail">
            <span>Monto:</span>
            <strong>Bs. {{ successTicket()!.bet.betAmount | number:'1.2-2' }}</strong>
          </div>
          <div class="detail highlight">
            <span>Ganancia Potencial:</span>
            <strong class="text-accent">Bs. {{ successTicket()!.bet.potentialWin | number:'1.2-2' }}</strong>
          </div>
        </div>
        <div class="success-actions">
          <button class="btn btn-primary" (click)="goBack()">Nueva Apuesta</button>
          <a routerLink="/consultar-ticket" class="btn btn-outline">Consultar Ticket</a>
        </div>
      </div>
    }

    <!-- Step 1: Select Game -->
    @if (!selectedGame() && !successTicket()) {
      <div class="games-grid">
        @for (game of games(); track game.id) {
          <div
            class="game-card card"
            [class.inactive]="!game.isActive"
            (click)="game.isActive && selectGame(game)"
          >
            <h3>{{ game.name }}</h3>
            <div class="game-info">
              <div class="info-item">
                <span>üïê</span>
                <strong>{{ formatTime(game.scheduledTime) }}</strong>
              </div>
              <div class="info-item">
                <span>Multiplicador:</span>
                <span class="text-accent">{{ game.payoutMultiplier }}x</span>
              </div>
              <div class="info-item">
                <span>Min/Max:</span>
                <span>Bs. {{ game.minBetAmount }} - {{ game.maxBetAmount }}</span>
              </div>
            </div>
            @if (!game.isActive) {
              <span class="badge badge-warning">Inactivo</span>
            } @else {
              <button class="btn btn-accent">Jugar</button>
            }
          </div>
        } @empty {
          <div class="empty-state card">
            <p>No hay juegos disponibles</p>
          </div>
        }
      </div>
    }

    <!-- Step 2: Select Draw -->
    @if (selectedGame() && !selectedDraw() && !successTicket()) {
      <div class="draws-section">
        <div class="section-header">
          <button class="btn btn-outline btn-sm" (click)="goBack()">‚Üê Volver</button>
          <h2>{{ selectedGame()!.name }}</h2>
        </div>

        <div class="draws-grid">
          @for (draw of openDraws(); track draw.id) {
            <div
              class="draw-card card"
              [class.closed]="draw.status !== 'open'"
              (click)="draw.status === 'open' && selectDraw(draw)"
            >
              <div class="draw-header">
                <h4>{{ draw.drawDate }}</h4>
                <span class="badge" [class]="getDrawStatusClass(draw)">
                  {{ getDrawStatusText(draw) }}
                </span>
              </div>
              @if (draw.status === 'open') {
                <button class="btn btn-accent">Seleccionar</button>
              }
            </div>
          } @empty {
            <div class="empty-state card">
              <p>No hay sorteos abiertos</p>
              <button class="btn btn-primary btn-sm" (click)="loadOpenDraws(selectedGame()!.id)">Actualizar</button>
            </div>
          }
        </div>
      </div>
    }

    <!-- Step 3: Select Animalito -->
    @if (selectedDraw() && !selectedAnimalito() && !successTicket()) {
      <div class="animalitos-section">
        <div class="section-header">
          <button class="btn btn-outline btn-sm" (click)="goBack()">‚Üê Volver</button>
          <div class="header-title">
            <h2>‚ú® Elige tu Animalito de la Suerte ‚ú®</h2>
            <p class="text-secondary">Del 1 al 36 - Haz clic en tu favorito</p>
          </div>
        </div>

        <div class="animalitos-star-container">
          @for (animalito of animalitos(); track animalito.id) {
            <div
              class="animalito-card-star"
              [class.pulse-animation]="animalito.number % 3 === 0"
              [style.animation-delay]="(animalito.number * 0.05) + 's'"
              (click)="selectAnimalito(animalito)"
            >
              <div class="animalito-inner">
                <div class="animalito-emoji">{{ getAnimalitoEmoji(animalito.number) }}</div>
                <div class="animalito-number-badge">{{ animalito.number }}</div>
                <div class="animalito-name-text">{{ animalito.name }}</div>
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- Step 4: Place Bet -->
    @if (selectedAnimalito() && !successTicket()) {
      <div class="bet-section">
        <div class="section-header">
          <button class="btn btn-outline btn-sm" (click)="goBack()">‚Üê Cambiar Animalito</button>
          <h2>Confirmar Apuesta</h2>
        </div>

        <div class="bet-container">
          <div class="bet-info card">
            <h3>{{ selectedGame()!.name }}</h3>
            <div class="selected-animalito">
              <div class="animalito-display">
                <div class="number">{{ selectedAnimalito()!.number }}</div>
                <div class="name">{{ selectedAnimalito()!.name }}</div>
              </div>
            </div>
            <div class="game-details">
              <p><strong>Fecha:</strong> {{ selectedDraw()!.drawDate }}</p>
              <p><strong>Hora:</strong> {{ formatTime(selectedGame()!.scheduledTime) }}</p>
              <p><strong>Multiplicador:</strong> <span class="text-accent">{{ selectedGame()!.payoutMultiplier }}x</span></p>
            </div>
          </div>

          <form [formGroup]="betForm" (ngSubmit)="placeBet()" class="bet-form card">
            <div class="form-group">
              <label for="betAmount">Monto (Bs.) *</label>
              <input
                type="number"
                id="betAmount"
                formControlName="betAmount"
                [min]="selectedGame()!.minBetAmount"
                [max]="selectedGame()!.maxBetAmount"
                placeholder="Monto a apostar"
              />
              <small class="text-secondary">
                M√≠nimo: Bs. {{ selectedGame()!.minBetAmount | number:'1.2-2' }} -
                M√°ximo: Bs. {{ selectedGame()!.maxBetAmount | number:'1.2-2' }}
              </small>
              @if (betForm.get('betAmount')?.invalid && betForm.get('betAmount')?.touched) {
                <span class="error-message">Monto debe estar entre el m√≠nimo y m√°ximo</span>
              }
            </div>

            <div class="form-group">
              <label for="userName">Nombre (opcional)</label>
              <input
                type="text"
                id="userName"
                formControlName="userName"
                placeholder="Tu nombre"
              />
            </div>

            <div class="form-group">
              <label for="userPhone">Tel√©fono (opcional)</label>
              <input
                type="tel"
                id="userPhone"
                formControlName="userPhone"
                placeholder="04121234567"
              />
              @if (betForm.get('userPhone')?.invalid && betForm.get('userPhone')?.touched) {
                <span class="error-message">Tel√©fono debe tener 10-11 d√≠gitos</span>
              }
            </div>

            @if (potentialWin() > 0) {
              <div class="potential-win">
                <span>Ganancia Potencial:</span>
                <strong class="text-accent">Bs. {{ potentialWin() | number:'1.2-2' }}</strong>
              </div>
            }

            <button
              type="submit"
              class="btn btn-accent btn-lg"
              [disabled]="betForm.invalid || loading()"
            >
              @if (loading()) {
                <span>Procesando...</span>
              } @else {
                <span>Confirmar Apuesta</span>
              }
            </button>
          </form>
        </div>
      </div>
    }
  </div>
</div>
