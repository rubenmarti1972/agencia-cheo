<div class="parley-page">
  <div class="container">
    <div class="page-header">
      <h1>⚽ Parley Deportivo</h1>
      <p>Combina tus apuestas y multiplica tus ganancias</p>
    </div>

    @if (loading() && !successTicket()) {
      <div class="loading-card card">Cargando...</div>
    }

    @if (error()) {
      <div class="error-card card">
        <p>{{ error() }}</p>
        <button class="btn btn-primary btn-sm" (click)="loadUpcomingMatches()">Reintentar</button>
      </div>
    }

    @if (successTicket()) {
      <div class="success-card card fade-in">
        <div class="success-icon">✅</div>
        <h2>¡Parley Creado!</h2>
        <div class="ticket-info">
          <p class="ticket-code">{{ successTicket()!.ticketCode }}</p>
        </div>
        <div class="ticket-details">
          <div class="detail"><span>Selecciones:</span><strong>{{ successTicket()!.ticket.legs?.length }}</strong></div>
          <div class="detail"><span>Cuota Total:</span><strong class="text-accent">{{ successTicket()!.ticket.totalOdds | number:'1.2-2' }}</strong></div>
          <div class="detail"><span>Monto:</span><strong>Bs. {{ successTicket()!.ticket.betAmount | number:'1.2-2' }}</strong></div>
          <div class="detail highlight">
            <span>Ganancia Potencial:</span>
            <strong class="text-accent">Bs. {{ successTicket()!.ticket.potentialWin | number:'1.2-2' }}</strong>
          </div>
        </div>
        <div class="success-actions">
          <button class="btn btn-primary" (click)="goBack()">Nuevo Parley</button>
          <a routerLink="/consultar-ticket" class="btn btn-outline">Consultar Ticket</a>
        </div>
      </div>
    }

    @if (!successTicket()) {
      <div class="parley-builder">
        <!-- Matches List -->
        <div class="matches-section">
          <h2>Partidos Disponibles</h2>
          <div class="matches-list">
            @for (match of matches(); track match.id) {
              <div class="match-card card">
                <div class="match-header">
                  <span class="sport-badge">{{ match.sport?.name }}</span>
                  <span class="match-date">{{ formatDate(match.matchDate) }}</span>
                </div>
                <div class="match-teams">
                  <div class="team">{{ match.homeTeam?.name }}</div>
                  <div class="vs">vs</div>
                  <div class="team">{{ match.awayTeam?.name }}</div>
                </div>
                @if (match.markets && match.markets.length > 0) {
                  <div class="markets">
                    @for (market of match.markets; track market.id) {
                      <button
                        class="market-btn"
                        [class.selected]="isMarketSelected(market.id)"
                        (click)="toggleMarket(market, match)"
                      >
                        <span class="market-name">{{ market.name }}</span>
                        <span class="market-odds">{{ market.odds }}</span>
                      </button>
                    }
                  </div>
                }
              </div>
            } @empty {
              <div class="empty-state card">No hay partidos disponibles</div>
            }
          </div>
        </div>

        <!-- Bet Slip -->
        <div class="bet-slip card">
          <h3>Mi Parley</h3>
          <div class="selections">
            @if (selectedMarkets().length === 0) {
              <p class="text-secondary">Selecciona al menos 2 mercados</p>
            } @else {
              @for (market of selectedMarkets(); track market.id) {
                <div class="selection-item">
                  <div class="selection-info">
                    <small>{{ market.match?.homeTeam?.name }} vs {{ market.match?.awayTeam?.name }}</small>
                    <strong>{{ market.name }}</strong>
                  </div>
                  <div class="selection-odds">{{ market.odds }}</div>
                </div>
              }
            }
          </div>

          @if (selectedMarkets().length >= 2) {
            <form [formGroup]="betForm" (ngSubmit)="placeBet()" class="bet-form">
              <div class="odds-summary">
                <span>Cuota Total:</span>
                <strong class="text-accent">{{ totalOdds() | number:'1.2-2' }}</strong>
              </div>

              <div class="form-group">
                <label for="betAmount">Monto (Bs.) *</label>
                <input type="number" id="betAmount" formControlName="betAmount" min="1" />
              </div>

              <div class="form-group">
                <label for="userName">Nombre (opcional)</label>
                <input type="text" id="userName" formControlName="userName" />
              </div>

              <div class="form-group">
                <label for="userPhone">Teléfono (opcional)</label>
                <input type="tel" id="userPhone" formControlName="userPhone" />
              </div>

              @if (potentialWin() > 0) {
                <div class="potential-win">
                  <span>Ganancia Potencial:</span>
                  <strong class="text-accent">Bs. {{ potentialWin() | number:'1.2-2' }}</strong>
                </div>
              }

              <button type="submit" class="btn btn-accent btn-lg" [disabled]="betForm.invalid || loading()">
                {{ loading() ? 'Procesando...' : 'Confirmar Parley' }}
              </button>
            </form>
          }
        </div>
      </div>
    }
  </div>
</div>
