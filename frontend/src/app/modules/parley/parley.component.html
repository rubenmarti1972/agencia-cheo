<div class="parley-page">
  <div class="container">
    <div class="page-header">
      <h1>‚öΩ Parley Deportivo</h1>
      <p>Combina tus apuestas y multiplica tus ganancias</p>
    </div>

    @if (loading() && !successTicket()) {
      <div class="loading-card card">Cargando...</div>
    }

    @if (error()) {
      <div class="error-card card">
        <p>{{ error() }}</p>
        <button class="btn btn-primary btn-sm" (click)="loadUpcomingMatches()">Reintentar</button>
      </div>
    }

    @if (successTicket()) {
      <div class="success-card card fade-in">
        <div class="success-icon">‚úÖ</div>
        <h2>¬°Ticket Creado Exitosamente!</h2>

        <div class="ticket-preview">
          <div class="ticket-header">
            <div class="ticket-logo">üé´</div>
            <div>
              <h3>AGENCIA CHEO</h3>
              <p class="ticket-code">{{ successTicket()!.ticketCode }}</p>
            </div>
          </div>

          <div class="ticket-customer">
            <p><strong>Cliente:</strong> {{ successTicket()!.ticket.userName || 'An√≥nimo' }}</p>
            @if (successTicket()!.ticket.userPhone) {
              <p><strong>Tel√©fono:</strong> {{ successTicket()!.ticket.userPhone }}</p>
            }
          </div>

          <div class="ticket-details">
            <div class="detail-row">
              <span>Selecciones:</span>
              <strong>{{ successTicket()!.ticket.legs?.length }}</strong>
            </div>
            <div class="detail-row">
              <span>Cuota Total:</span>
              <strong class="text-accent">{{ successTicket()!.ticket.totalOdds | number:'1.2-2' }}</strong>
            </div>
            <div class="detail-row">
              <span>Monto Apostado:</span>
              <strong>Bs. {{ successTicket()!.ticket.betAmount | number:'1.2-2' }}</strong>
            </div>
            <div class="detail-row highlight">
              <span>Ganancia Potencial:</span>
              <strong class="win-amount">Bs. {{ successTicket()!.ticket.potentialWin | number:'1.2-2' }}</strong>
            </div>
          </div>

          <div class="ticket-selections">
            <h4>Tus Selecciones:</h4>
            @for (leg of successTicket()!.ticket.legs; track leg.id) {
              <div class="selection-detail">
                <div class="selection-match-info">
                  <div class="match-teams-compact">
                    <div class="team-compact">
                      @if (leg.market?.match?.homeTeam?.logoUrl) {
                        <img [src]="leg.market.match.homeTeam.logoUrl" [alt]="leg.market.match.homeTeam.name" class="team-logo-small" />
                      }
                      <span>{{ leg.market?.match?.homeTeam?.name }}</span>
                    </div>
                    <span class="vs-compact">vs</span>
                    <div class="team-compact">
                      @if (leg.market?.match?.awayTeam?.logoUrl) {
                        <img [src]="leg.market.match.awayTeam.logoUrl" [alt]="leg.market.match.awayTeam.name" class="team-logo-small" />
                      }
                      <span>{{ leg.market?.match?.awayTeam?.name }}</span>
                    </div>
                  </div>
                  <div class="selection-pick">
                    <span class="pick-label">{{ leg.market?.name }}</span>
                    <strong class="pick-odds">{{ leg.odds | number:'1.2-2' }}</strong>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>

        <div class="success-actions">
          <button class="btn btn-primary" (click)="goBack()">Nuevo Parley</button>
          <a routerLink="/consultar-ticket" class="btn btn-outline">Consultar Ticket</a>
        </div>
      </div>
    }

    @if (!successTicket()) {
      <div class="parley-builder">
        <!-- Matches Section -->
        <div class="matches-section">
          <h2>üìÖ Partidos Disponibles</h2>

          @for (match of matches(); track match.id) {
            <div class="match-card card">
              <!-- Match Header -->
              <div class="match-header">
                <div class="match-info">
                  <span class="sport-badge">{{ match.sport?.name }}</span>
                  <span class="match-date">{{ formatDate(match.matchDate) }}</span>
                </div>
              </div>

              <!-- Match Teams -->
              <div class="match-teams">
                <div class="team home">
                  @if (match.homeTeam?.logoUrl) {
                    <img [src]="match.homeTeam.logoUrl" [alt]="match.homeTeam.name" class="team-logo" />
                  }
                  <span class="team-name">{{ match.homeTeam?.name }}</span>
                </div>
                <div class="vs">vs</div>
                <div class="team away">
                  @if (match.awayTeam?.logoUrl) {
                    <img [src]="match.awayTeam.logoUrl" [alt]="match.awayTeam.name" class="team-logo" />
                  }
                  <span class="team-name">{{ match.awayTeam?.name }}</span>
                </div>
              </div>

              <!-- Markets -->
              @if (match.markets && match.markets.length > 0) {
                <div class="markets-container">
                  <!-- Ganador del Partido (1X2) -->
                  @if (getMarketsByType(match.markets, 'moneyline').length > 0) {
                    <div class="market-group">
                      <h4 class="market-title">1X2 - Resultado Final</h4>
                      <div class="markets-grid">
                        @for (market of getMarketsByType(match.markets, 'moneyline'); track market.id) {
                          <button
                            class="market-btn"
                            [class.selected]="isMarketSelected(market.id)"
                            (click)="toggleMarket(market, match)"
                          >
                            <span class="market-name">{{ market.name }}</span>
                            <span class="market-odds">{{ market.odds | number:'1.2-2' }}</span>
                          </button>
                        }
                      </div>
                    </div>
                  }

                  <!-- Over/Under -->
                  @if (getMarketsByType(match.markets, 'over_under').length > 0) {
                    <div class="market-group">
                      <h4 class="market-title">Total de Goles</h4>
                      <div class="markets-grid">
                        @for (market of getMarketsByType(match.markets, 'over_under'); track market.id) {
                          <button
                            class="market-btn"
                            [class.selected]="isMarketSelected(market.id)"
                            (click)="toggleMarket(market, match)"
                          >
                            <span class="market-name">{{ market.name }}</span>
                            <span class="market-odds">{{ market.odds | number:'1.2-2' }}</span>
                          </button>
                        }
                      </div>
                    </div>
                  }

                  <!-- Both Teams Score -->
                  @if (getMarketsByType(match.markets, 'both_teams_score').length > 0) {
                    <div class="market-group">
                      <h4 class="market-title">Ambos Equipos Anotan</h4>
                      <div class="markets-grid">
                        @for (market of getMarketsByType(match.markets, 'both_teams_score'); track market.id) {
                          <button
                            class="market-btn"
                            [class.selected]="isMarketSelected(market.id)"
                            (click)="toggleMarket(market, match)"
                          >
                            <span class="market-name">{{ market.name }}</span>
                            <span class="market-odds">{{ market.odds | number:'1.2-2' }}</span>
                          </button>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          } @empty {
            <div class="empty-state card">
              <p>No hay partidos disponibles en este momento</p>
              <button class="btn btn-primary" (click)="loadUpcomingMatches()">Recargar</button>
            </div>
          }
        </div>

        <!-- Bet Slip (Carrito de Apuestas) -->
        <div class="bet-slip card">
          <h3>üéØ Mi Parley</h3>

          @if (selectedMarkets().length === 0) {
            <div class="empty-slip">
              <p>Selecciona al menos 2 mercados de diferentes partidos para crear tu parley</p>
            </div>
          } @else {
            <div class="selections">
              @for (market of selectedMarkets(); track market.id) {
                <div class="selection-item">
                  <button class="remove-btn" (click)="removeMarket(market.id)" title="Eliminar">√ó</button>
                  <div class="selection-info">
                    <div class="selection-match-header">
                      <div class="teams-inline">
                        @if (market.match?.homeTeam?.logoUrl) {
                          <img [src]="market.match.homeTeam.logoUrl" [alt]="market.match.homeTeam.name" class="team-logo-tiny" />
                        }
                        <span class="team-name-short">{{ market.match?.homeTeam?.name }}</span>
                        <span class="vs-tiny">vs</span>
                        @if (market.match?.awayTeam?.logoUrl) {
                          <img [src]="market.match.awayTeam.logoUrl" [alt]="market.match.awayTeam.name" class="team-logo-tiny" />
                        }
                        <span class="team-name-short">{{ market.match?.awayTeam?.name }}</span>
                      </div>
                    </div>
                    <div class="selection-pick">
                      <strong>{{ market.name }}</strong>
                      <span class="selection-odds">{{ market.odds | number:'1.2-2' }}</span>
                    </div>
                  </div>
                </div>
              }
            </div>

            <!-- Cuotas Combinadas -->
            <div class="total-odds-section">
              <div class="odds-calculation">
                <span>Cuota Total:</span>
                @for (market of selectedMarkets(); track market.id; let i = $index) {
                  <span class="odd-item">
                    {{ market.odds | number:'1.2-2' }}{{ i < selectedMarkets().length - 1 ? ' √ó ' : '' }}
                  </span>
                }
              </div>
              <div class="total-odds-result">
                <strong>= {{ totalOdds() | number:'1.2-2' }}</strong>
              </div>
            </div>

            @if (selectedMarkets().length >= 2) {
              <form [formGroup]="betForm" (ngSubmit)="placeBet()" class="bet-form">
                <!-- Datos del Cliente -->
                <div class="customer-section">
                  <h4>üìù Datos del Cliente</h4>

                  <div class="form-group">
                    <label for="userName">Nombre Completo *</label>
                    <input
                      type="text"
                      id="userName"
                      formControlName="userName"
                      placeholder="Ej: Juan P√©rez"
                      required
                    />
                    @if (betForm.get('userName')?.invalid && betForm.get('userName')?.touched) {
                      <small class="error-text">El nombre es requerido</small>
                    }
                  </div>

                  <div class="form-group">
                    <label for="userCedula">C√©dula *</label>
                    <input
                      type="text"
                      id="userCedula"
                      formControlName="userCedula"
                      placeholder="Ej: V-12345678"
                      required
                    />
                    @if (betForm.get('userCedula')?.invalid && betForm.get('userCedula')?.touched) {
                      <small class="error-text">La c√©dula es requerida</small>
                    }
                  </div>

                  <div class="form-group">
                    <label for="userPhone">Tel√©fono *</label>
                    <input
                      type="tel"
                      id="userPhone"
                      formControlName="userPhone"
                      placeholder="Ej: 04121234567"
                      required
                    />
                    @if (betForm.get('userPhone')?.hasError('required') && betForm.get('userPhone')?.touched) {
                      <small class="error-text">El tel√©fono es requerido</small>
                    } @else if (betForm.get('userPhone')?.hasError('pattern') && betForm.get('userPhone')?.touched) {
                      <small class="error-text">Debe tener 10-11 d√≠gitos (Ej: 04121234567)</small>
                    }
                  </div>
                </div>

                <!-- Monto de Apuesta -->
                <div class="amount-section">
                  <h4>üíµ Monto a Apostar</h4>

                  <div class="form-group">
                    <label for="betAmount">Monto (Bs.) *</label>
                    <input
                      type="number"
                      id="betAmount"
                      formControlName="betAmount"
                      min="1"
                      step="0.01"
                      placeholder="Ingresa el monto"
                      required
                    />
                    @if (betForm.get('betAmount')?.invalid && betForm.get('betAmount')?.touched) {
                      <small class="error-text">El monto debe ser mayor a Bs. 1.00</small>
                    } @else {
                      <small>M√≠nimo: Bs. 1.00</small>
                    }
                  </div>

                  <!-- Botones de Montos R√°pidos -->
                  <div class="quick-amounts">
                    <button type="button" class="quick-btn" (click)="setQuickAmount(10)">Bs. 10</button>
                    <button type="button" class="quick-btn" (click)="setQuickAmount(20)">Bs. 20</button>
                    <button type="button" class="quick-btn" (click)="setQuickAmount(50)">Bs. 50</button>
                    <button type="button" class="quick-btn" (click)="setQuickAmount(100)">Bs. 100</button>
                  </div>
                </div>

                <!-- Ganancia Potencial -->
                @if (potentialWin() > 0) {
                  <div class="potential-win-card">
                    <div class="win-calculation">
                      <span class="calc-formula">
                        Bs. {{ betForm.get('betAmount')?.value || 0 | number:'1.2-2' }}
                        √ó
                        {{ totalOdds() | number:'1.2-2' }}
                      </span>
                    </div>
                    <div class="win-result">
                      <span>üèÜ Ganancia Potencial:</span>
                      <strong class="win-amount">Bs. {{ potentialWin() | number:'1.2-2' }}</strong>
                    </div>
                  </div>
                }

                <!-- Bot√≥n de Crear Ticket -->
                <button
                  type="submit"
                  class="btn btn-primary btn-lg btn-submit"
                  [disabled]="betForm.invalid || loading() || selectedMarkets().length < 2"
                >
                  {{ loading() ? '‚è≥ Procesando...' : '‚úÖ Crear Ticket' }}
                </button>
              </form>
            } @else {
              <div class="min-selections-warning">
                <p>‚ö†Ô∏è Necesitas al menos 2 selecciones para crear un parley</p>
              </div>
            }
          }
        </div>
      </div>
    }
  </div>
</div>
